import re
import os
import asyncio
import math
from threading import Thread
from flask import Flask
from telethon import TelegramClient, events
from telethon.sessions import StringSession

# ==========================================
# âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª (Config)
# ==========================================

API_ID = os.environ.get("API_ID", 33888256)
API_HASH = os.environ.get("API_HASH", 'bb1902689a7e203a7aedadb806c08854')
SESSION_STRING = os.environ.get("SESSION_STRING", "YOUR_SESSION_HERE")

ZONE_GROUPS = {
    'Ø´Ù…Ø§Ù„ Ø¬Ø¯Ø©': -1003760776543, 
    'ÙˆØ³Ø· Ø¬Ø¯Ø©': -1003596443115,
    'Ø¬Ù†ÙˆØ¨ Ø¬Ø¯Ø©': -1003817286093,
    'Ø´Ø±Ù‚ Ø¬Ø¯Ø©': -1003771356422
}

KEYWORDS = ['Ø´Ù‡Ø±ÙŠ', 'Ø¨Ø§Ù„Ø´Ù‡Ø±', 'Ø´Ù‡Ø±ÙŠØ§', 'Ø¹Ù‚Ø¯', 'Ø¯ÙˆØ§Ù…', 'Ù…Ø´ÙˆØ§Ø± Ø«Ø¨Ø§Øª']

# (Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ© DISTRICT_COORDS Ùˆ JEDDAH_ZONES ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ ÙÙŠ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø£ØµÙ„ÙŠ)
# ... [ØªÙˆØ¶Ø¹ Ù‡Ù†Ø§ Ù…ØµÙÙˆÙØ§Øª Ø§Ù„Ø£Ø­ÙŠØ§Ø¡ ÙˆØ§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª] ...
JEDDAH_ZONES = {
    'Ø´Ù…Ø§Ù„ Ø¬Ø¯Ø©': [
        'Ø£Ø¨Ø­Ø± Ø§Ù„Ø´Ù…Ø§Ù„ÙŠØ©', 'Ø£Ø¨Ø­Ø± Ø§Ù„Ø¬Ù†ÙˆØ¨ÙŠØ©', 'Ø§Ù„Ø­Ù…Ø¯Ø§Ù†ÙŠØ©', 'Ø§Ù„Ù…Ø±Ø¬Ø§Ù†', 'Ø§Ù„Ø¨Ø³Ø§ØªÙŠÙ†', 'Ø§Ù„Ù†Ø¹ÙŠÙ…', 
        'Ø§Ù„Ù…Ø­Ù…Ø¯ÙŠØ©', 'Ø§Ù„Ø´Ø§Ø·Ø¦', 'Ø§Ù„Ø±Ø­ÙŠÙ„ÙŠ', 'Ø°Ù‡Ø¨Ø§Ù†', 'Ø·ÙŠØ¨Ø©', 'Ø§Ù„ØµØ§Ù„Ø© Ø§Ù„Ø´Ù…Ø§Ù„ÙŠØ©', 'Ø§Ù„ÙØ±ÙˆØ³ÙŠØ©',
        'Ø§Ù„ÙÙ„Ø§Ø­', 'Ø§Ù„Ø±ÙŠØ§Ø¶', 'Ø§Ù„Ø²Ù…Ø±Ø¯', 'Ø§Ù„ÙŠØ§Ù‚ÙˆØª', 'Ø§Ù„Ù„Ø¤Ù„Ø¤', 'Ø§Ù„Ù…Ù†Ø§Ø±', 'Ø§Ù„ØµÙˆØ§Ø±ÙŠ', 
        'Ø®Ø§Ù„Ø¯ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©', 'Ù…Ø·Ø§Ø± Ø§Ù„Ù…Ù„Ùƒ Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ²', 'Ø§Ù„Ø£Ù…ÙˆØ§Ø¬', 'Ø§Ù„ÙØ±Ø¯ÙˆØ³', 'Ø§Ù„Ø´Ø±Ø§Ø¹', 
        'Ø§Ù„Ù…Ù†Ø§Ø±Ø§Øª', 'Ø§Ù„ØµØ§Ù„Ø­ÙŠØ©', 'Ø§Ù„Ù…Ø§Ø¬Ø¯', 'Ø§Ù„Ø³Ù„Ø·Ø§Ù†', 'Ø§Ù„Ù†Ø²Ù‡Ø©'
    ],
    'ÙˆØ³Ø· Ø¬Ø¯Ø©': [
        'Ø§Ù„Ø±ÙˆØ¶Ø©', 'Ø§Ù„Ø³Ù„Ø§Ù…Ø©', 'Ø§Ù„ØªØ­Ù„ÙŠØ©', 'Ø§Ù„Ø¹Ø²ÙŠØ²ÙŠØ©', 'Ù…Ø´Ø±ÙØ©', 'Ø§Ù„Ù†Ø³ÙŠÙ…', 'Ø§Ù„ÙÙŠØ­Ø§Ø¡',
        'Ø¨Ù†ÙŠ Ù…Ø§Ù„Ùƒ', 'Ø§Ù„Ø­Ù…Ø±Ø§Ø¡', 'Ø§Ù„ÙÙŠØµÙ„ÙŠØ©', 'Ø§Ù„Ø±Ø¨ÙˆØ©', 'Ø§Ù„ØµÙØ§', 'Ø§Ù„Ù…Ø±ÙˆØ©', 'Ø§Ù„Ø¨ÙˆØ§Ø¯ÙŠ',
        'Ø§Ù„Ø§Ù†Ø¯Ù„Ø³', 'Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ÙŠØ©', 'Ø§Ù„ÙˆØ±ÙˆØ¯', 'Ø§Ù„Ø±Ø­Ø§Ø¨', 'ÙƒÙ†Ø¯Ø±Ø©', 'Ø§Ù„Ø¹Ù…Ø§Ø±ÙŠØ©', 'Ø§Ù„ØµØ­ÙŠÙØ©', 
        'Ø§Ù„Ø¨ØºØ¯Ø§Ø¯ÙŠØ©', 'Ø­ÙŠ Ø§Ù„Ø¨Ù„Ø¯', 'Ø§Ù„Ø±ÙˆÙŠØ³', 'Ø§Ù„Ù‡Ù†Ø¯Ø§ÙˆÙŠØ©', 'Ø§Ù„Ø«Ø¹Ø§Ù„Ø¨Ø©', 'Ø§Ù„Ù‚Ø±ÙŠØ§Øª', 'Ø§Ù„Ø³Ø¨ÙŠÙ„'
    ],
    'Ø¬Ù†ÙˆØ¨ Ø¬Ø¯Ø©': [
        'Ø§Ù„ÙˆØ²ÙŠØ±ÙŠØ©', 'Ø§Ù„Ø£Ù…ÙŠØ± ÙÙˆØ§Ø²', 'Ø§Ù„Ø£Ù…ÙŠØ± Ø¹Ø¨Ø¯Ø§Ù„Ù…Ø¬ÙŠØ¯', 'Ø§Ù„Ø¹Ø¯Ù„', 'Ø§Ù„Ø³Ù†Ø§Ø¨Ù„', 'Ø§Ù„Ø±ÙˆØ§Ø¨ÙŠ', 
        'Ø§Ù„Ø®Ù…Ø±Ø©', 'ØºÙ„ÙŠÙ„', 'Ø§Ù„Ù…Ø­Ø¬Ø±', 'Ø§Ù„Ù‚Ø±ÙŠÙ†ÙŠØ©', 'Ø§Ù„Ø£Ø¬Ø§ÙˆÙŠØ¯', 'Ø­ÙŠ Ø§Ù„Ù‡Ø¯Ù‰', 'Ø§Ù„Ù…Ø¯Ø§Ø¦Ù†', 
        'Ø§Ù„ÙØ¶ÙŠÙ„Ø©', 'Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª Ø§Ù„Ø¥Ø³ÙƒØ§Ù†', 'Ø­ÙŠ Ø¨ØªØ±ÙˆÙ…ÙŠÙ†', 'Ø§Ù„Ù‚ÙˆØ²ÙŠÙ†', 'Ø§Ù„Ø³Ø±ÙˆØ±ÙŠØ©', 'Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª',
        'Ø§Ù„Ø£Ø¬ÙˆØ§Ø¯ Ø§Ù„Ø¬Ù†ÙˆØ¨ÙŠ', 'Ø¶Ø§Ø­ÙŠØ© Ø§Ù„Ø­Ø±Ø²Ø§Øª', 'Ø§Ù„Ù‡Ø¯Ù‰ 2'
    ],
    'Ø´Ø±Ù‚ Ø¬Ø¯Ø©': [
        'Ø§Ù„Ø³Ø§Ù…Ø±', 'Ø§Ù„Ù…Ù†Ø§Ø±', 'Ø§Ù„Ø£Ø¬ÙˆØ§Ø¯', 'Ù…Ø®Ø·Ø· Ø§Ù„ÙÙ‡Ø¯', 'Ø§Ù„Ø­Ø±Ø§Ø²Ø§Øª', 'Ø§Ù„Ø³Ù„ÙŠÙ…Ø§Ù†ÙŠØ©', 
        'Ø§Ù„ÙˆØ§Ø­Ø©', 'Ø¨Ø±ÙŠÙ…Ø§Ù†', 'Ø§Ù„ØªÙŠØ³ÙŠØ±', 'Ø§Ù„Ø±Ø§ÙŠØ©', 'Ø§Ù„Ù†Ø®ÙŠÙ„', 'Ù…Ø®Ø·Ø· Ø§Ù„Ø±ÙŠØ§Ø¶', 
        'Ø­ÙŠ Ø§Ù„Ø³Ù„Ù…ÙŠØ©', 'Ø§Ù„Ù…Ø±ÙˆØ© Ø§Ù„Ø´Ø±Ù‚ÙŠØ©', 'Ø£Ù… Ø§Ù„Ø­Ø¨Ù„ÙŠÙ†', 'ÙˆØ§Ø¯ÙŠ Ù…Ø±ÙŠØ®', 'Ù…Ø®Ø·Ø· Ù…Ø±ÙŠØ®',
        'Ø§Ù„Ù†Ø²Ù‡Ø© Ø§Ù„Ø´Ø±Ù‚ÙŠØ©', 'Ø¨Ù†ÙŠ Ù…Ø§Ù„Ùƒ Ø§Ù„Ø´Ø±Ù‚ÙŠØ©', 'Ù…Ø®Ø·Ø· Ø§Ù„Ù…ØµØ¨Ø§Ø­'
    ]
}

DISTRICT_COORDS = {
    'Ø£Ø¨Ø­Ø± Ø§Ù„Ø´Ù…Ø§Ù„ÙŠØ©': (21.7511, 39.1235), 'Ø£Ø¨Ø­Ø± Ø§Ù„Ø¬Ù†ÙˆØ¨ÙŠØ©': (21.7144, 39.1256),
    'Ø§Ù„Ø­Ù…Ø¯Ø§Ù†ÙŠØ©': (21.7831, 39.2161), 'Ø§Ù„Ù…Ø±Ø¬Ø§Ù†': (21.7011, 39.1022),
    'Ø§Ù„Ø¨Ø³Ø§ØªÙŠÙ†': (21.6885, 39.1255), 'Ø§Ù„Ù†Ø¹ÙŠÙ…': (21.6255, 39.1550),
    'Ø§Ù„Ù…Ø­Ù…Ø¯ÙŠØ©': (21.6500, 39.1350), 'Ø§Ù„Ø´Ø§Ø·Ø¦': (21.6100, 39.1150),
    'Ø§Ù„Ø±Ø­ÙŠÙ„ÙŠ': (21.8200, 39.1500), 'Ø°Ù‡Ø¨Ø§Ù†': (21.9333, 39.1167),
    'Ø·ÙŠØ¨Ø©': (21.8000, 39.1800), 'Ø§Ù„ØµØ§Ù„Ø© Ø§Ù„Ø´Ù…Ø§Ù„ÙŠØ©': (21.6950, 39.1620),
    'Ø§Ù„ÙØ±ÙˆØ³ÙŠØ©': (21.8150, 39.2250), 'Ø§Ù„ÙÙ„Ø§Ø­': (21.7900, 39.2300),
    'Ø§Ù„Ø±ÙŠØ§Ø¶': (21.8450, 39.2350), 'Ø§Ù„Ø²Ù…Ø±Ø¯': (21.7750, 39.1100),
    'Ø§Ù„ÙŠØ§Ù‚ÙˆØª': (21.7650, 39.1150), 'Ø§Ù„Ù„Ø¤Ù„Ø¤': (21.7450, 39.1050),
    'Ø§Ù„ØµÙˆØ§Ø±ÙŠ': (21.7850, 39.1250), 'Ø®Ø§Ù„Ø¯ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©': (21.7200, 39.1850),
    'Ù…Ø·Ø§Ø± Ø§Ù„Ù…Ù„Ùƒ Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ²': (21.6833, 39.1500), 'Ø§Ù„Ø£Ù…ÙˆØ§Ø¬': (21.7300, 39.1100),
    'Ø§Ù„ÙØ±Ø¯ÙˆØ³': (21.7400, 39.1200), 'Ø§Ù„Ø´Ø±Ø§Ø¹': (21.7250, 39.1150),
    'Ø§Ù„Ù…Ù†Ø§Ø±Ø§Øª': (21.7100, 39.1300), 'Ø§Ù„ØµØ§Ù„Ø­ÙŠØ©': (21.7950, 39.2100),
    'Ø§Ù„Ù…Ø§Ø¬Ø¯': (21.8050, 39.2200), 'Ø§Ù„Ø³Ù„Ø·Ø§Ù†': (21.8100, 39.2150),
    'Ø§Ù„Ù†Ø²Ù‡Ø©': (21.6400, 39.1700),
    'Ø§Ù„Ø±ÙˆØ¶Ø©': (21.5667, 39.1500), 'Ø§Ù„Ø³Ù„Ø§Ù…Ø©': (21.5833, 39.1500),
    'Ø§Ù„ØªØ­Ù„ÙŠØ©': (21.5510, 39.1650), 'Ø§Ù„Ø¹Ø²ÙŠØ²ÙŠØ©': (21.5450, 39.1850),
    'Ù…Ø´Ø±ÙØ©': (21.5350, 39.1950), 'Ø§Ù„Ù†Ø³ÙŠÙ…': (21.5050, 39.2250),
    'Ø§Ù„ÙÙŠØ­Ø§Ø¡': (21.4950, 39.2350), 'Ø¨Ù†ÙŠ Ù…Ø§Ù„Ùƒ': (21.5150, 39.2150),
    'Ø§Ù„Ø­Ù…Ø±Ø§Ø¡': (21.5200, 39.1550), 'Ø§Ù„ÙÙŠØµÙ„ÙŠØ©': (21.5750, 39.1750),
    'Ø§Ù„Ø±Ø¨ÙˆØ©': (21.5950, 39.1850), 'Ø§Ù„ØµÙØ§': (21.5850, 39.2050),
    'Ø§Ù„Ù…Ø±ÙˆØ©': (21.6150, 39.2050), 'Ø§Ù„Ø¨ÙˆØ§Ø¯ÙŠ': (21.5950, 39.1650),
    'Ø§Ù„Ø§Ù†Ø¯Ù„Ø³': (21.5400, 39.1450), 'Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ÙŠØ©': (21.5300, 39.1700),
    'Ø§Ù„ÙˆØ±ÙˆØ¯': (21.5250, 39.2150), 'Ø§Ù„Ø±Ø­Ø§Ø¨': (21.5550, 39.2150),
    'ÙƒÙ†Ø¯Ø±Ø©': (21.4950, 39.2050), 'Ø§Ù„Ø¹Ù…Ø§Ø±ÙŠØ©': (21.4880, 39.1950),
    'Ø§Ù„ØµØ­ÙŠÙØ©': (21.4850, 39.1900), 'Ø§Ù„Ø¨ØºØ¯Ø§Ø¯ÙŠØ©': (21.4950, 39.1850),
    'Ø­ÙŠ Ø§Ù„Ø¨Ù„Ø¯': (21.4833, 39.1833), 'Ø§Ù„Ø±ÙˆÙŠØ³': (21.5100, 39.1650),
    'Ø§Ù„Ù‡Ù†Ø¯Ø§ÙˆÙŠØ©': (21.4750, 39.1800), 'Ø§Ù„Ø«Ø¹Ø§Ù„Ø¨Ø©': (21.4650, 39.1850),
    'Ø§Ù„Ù‚Ø±ÙŠØ§Øª': (21.4600, 39.1900), 'Ø§Ù„Ø³Ø¨ÙŠÙ„': (21.4700, 39.1900),
    'Ø§Ù„ÙˆØ²ÙŠØ±ÙŠØ©': (21.4600, 39.2350), 'Ø§Ù„Ø£Ù…ÙŠØ± ÙÙˆØ§Ø²': (21.4250, 39.2650),
    'Ø§Ù„Ø£Ù…ÙŠØ± Ø¹Ø¨Ø¯Ø§Ù„Ù…Ø¬ÙŠØ¯': (21.4050, 39.2750), 'Ø§Ù„Ø¹Ø¯Ù„': (21.4550, 39.2550),
    'Ø§Ù„Ø³Ù†Ø§Ø¨Ù„': (21.3650, 39.2850), 'Ø§Ù„Ø±ÙˆØ§Ø¨ÙŠ': (21.4750, 39.2550),
    'Ø§Ù„Ø®Ù…Ø±Ø©': (21.3000, 39.2200), 'ØºÙ„ÙŠÙ„': (21.4450, 39.2050),
    'Ø§Ù„Ù…Ø­Ø¬Ø±': (21.4400, 39.1950), 'Ø§Ù„Ù‚Ø±ÙŠÙ†ÙŠØ©': (21.3250, 39.2350),
    'Ø§Ù„Ø£Ø¬Ø§ÙˆÙŠØ¯': (21.3850, 39.2850), 'Ø­ÙŠ Ø§Ù„Ù‡Ø¯Ù‰': (21.3950, 39.2550),
    'Ø§Ù„Ù…Ø¯Ø§Ø¦Ù†': (21.3500, 39.2450), 'Ø§Ù„ÙØ¶ÙŠÙ„Ø©': (21.3150, 39.2550),
    'Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª Ø§Ù„Ø¥Ø³ÙƒØ§Ù†': (21.4150, 39.2250), 'Ø­ÙŠ Ø¨ØªØ±ÙˆÙ…ÙŠÙ†': (21.4350, 39.1850),
    'Ø§Ù„Ù‚ÙˆØ²ÙŠÙ†': (21.2850, 39.2050), 'Ø§Ù„Ø³Ø±ÙˆØ±ÙŠØ©': (21.3350, 39.1950),
    'Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª': (21.4000, 39.2400), 'Ø§Ù„Ù‡Ø¯Ù‰ 2': (21.3800, 39.2600),
    'Ø§Ù„Ø³Ø§Ù…Ø±': (21.6050, 39.2450), 'Ø§Ù„Ù…Ù†Ø§Ø±': (21.6050, 39.2300),
    'Ø§Ù„Ø£Ø¬ÙˆØ§Ø¯': (21.6150, 39.2550), 'Ù…Ø®Ø·Ø· Ø§Ù„ÙÙ‡Ø¯': (21.6250, 39.2650),
    'Ø§Ù„Ø­Ø±Ø§Ø²Ø§Øª': (21.4550, 39.3650), 'Ø§Ù„Ø³Ù„ÙŠÙ…Ø§Ù†ÙŠØ©': (21.4950, 39.2450),
    'Ø§Ù„ÙˆØ§Ø­Ø©': (21.5650, 39.2450), 'Ø¨Ø±ÙŠÙ…Ø§Ù†': (21.6550, 39.2550),
    'Ø§Ù„ØªÙŠØ³ÙŠØ±': (21.5750, 39.2750), 'Ø§Ù„Ø±Ø§ÙŠØ©': (21.6250, 39.2750),
    'Ø§Ù„Ù†Ø®ÙŠÙ„': (21.5250, 39.2650), 'Ù…Ø®Ø·Ø· Ø§Ù„Ø±ÙŠØ§Ø¶': (21.8450, 39.2350),
    'Ø­ÙŠ Ø§Ù„Ø³Ù„Ù…ÙŠØ©': (21.4450, 39.2850), 'Ø§Ù„Ù…Ø±ÙˆØ© Ø§Ù„Ø´Ø±Ù‚ÙŠØ©': (21.6250, 39.2150),
    'Ø£Ù… Ø§Ù„Ø­Ø¨Ù„ÙŠÙ†': (21.5850, 39.2950), 'ÙˆØ§Ø¯ÙŠ Ù…Ø±ÙŠØ®': (21.5450, 39.3050),
    'Ù…Ø®Ø·Ø· Ù…Ø±ÙŠØ®': (21.5500, 39.3100), 'Ù…Ø®Ø·Ø· Ø§Ù„Ù…ØµØ¨Ø§Ø­': (21.5900, 39.2600)
}


# ==========================================
# ğŸ› ï¸ Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ø°ÙƒÙŠ (Intelligence Engine)
# ==========================================

def normalize_arabic_text(text):
    if not text: return ""
    text = text.strip()
    text = re.sub(r'[Ø£Ø¥Ø¢]', 'Ø§', text)
    text = re.sub(r'Ø©', 'Ù‡', text)
    tashkeel = re.compile(r'[\u064B-\u0652]')
    text = re.sub(tashkeel, '', text)
    text = re.sub(r'http\S+|www\S+|@\S+', '', text)
    return text

def extract_smart_details(text):
    """Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø³Ø¹Ø± ÙˆØ¹Ø¯Ø¯ Ø§Ù„Ø±ÙƒØ§Ø¨ Ù…Ù† Ø§Ù„Ù†Øµ"""
    price_match = re.search(r'(\d{3,4})\s?(Ø±ÙŠØ§Ù„|Ø±|Ø§Ù„Ø³Ø¹Ø±)', text)
    passengers_match = re.search(r'(Ø¹Ø¯Ø¯|Ø§Ø­Ù†Ø§|Ø±ÙƒØ§Ø¨)\s?(\d)', text)
    
    price = price_match.group(1) if price_match else "Ø¨Ø§Ù„Ø§ØªÙØ§Ù‚"
    passengers = passengers_match.group(2) if passengers_match else "1"
    return price, passengers

def calculate_distance(origin_name, dest_name):
    coords1 = DISTRICT_COORDS.get(origin_name)
    coords2 = DISTRICT_COORDS.get(dest_name)
    if not coords1 or not coords2: return None, None
    
    lat1, lon1 = coords1
    lat2, lon2 = coords2
    R = 6371
    dlat = math.radians(lat2 - lat1)
    dlon = math.radians(lon2 - lon1)
    a = (math.sin(dlat / 2) ** 2 + math.cos(math.radians(lat1)) * math.cos(math.radians(lat2)) * math.sin(dlon / 2) ** 2)
    c = 2 * math.atan2(math.sqrt(a), math.sqrt(1 - a))
    
    actual_dist = round(R * c * 1.3, 1)
    est_time = round((actual_dist / 40) * 60) + 10
    return actual_dist, est_time

# ==========================================
# ğŸ§  Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø·ÙˆØ±
# ==========================================

client = TelegramClient(StringSession(SESSION_STRING), API_ID, API_HASH)
pending_orders = {zone: [] for zone in JEDDAH_ZONES.keys()}

@client.on(events.NewMessage)
async def main_handler(event):
    if not event.is_group: return
    raw_text = event.raw_text
    if not raw_text: return

    processed_text = normalize_arabic_text(raw_text)
    if not any(normalize_arabic_text(k) in processed_text for k in KEYWORDS): return

    origin, dest, found_zone = "ØºÙŠØ± Ù…Ø­Ø¯Ø¯", "ØºÙŠØ± Ù…Ø­Ø¯Ø¯", None

    # ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹
    for zone, districts in JEDDAH_ZONES.items():
        for d in districts:
            norm_d = normalize_arabic_text(d)
            if norm_d in processed_text:
                if ' Ù…Ù† ' + norm_d in processed_text: origin, found_zone = d, zone
                elif ' Ø§Ù„Ù‰ ' + norm_d in processed_text or ' Ù„Ø­ÙŠ ' + norm_d in processed_text: dest = d
                else:
                    if origin == "ØºÙŠØ± Ù…Ø­Ø¯Ø¯": origin, found_zone = d, zone

    if found_zone:
        try:
            dist, time = calculate_distance(origin, dest)
            price, passengers = extract_smart_details(raw_text)
            sender = await event.get_sender()
            
            chat = await event.get_chat()
            chat_id = str(chat.id).replace("-100", "")
            msg_url = f"https://t.me/c/{chat_id}/{event.message.id}"

            new_order = {
                'origin': origin, 'dest': dest, 'dist': dist, 'time': time,
                'price': price, 'passengers': passengers,
                'name': sender.first_name if sender else "Ø¹Ù…ÙŠÙ„",
                'link': f"tg://user?id={sender.id}" if sender else "#",
                'msg_url': msg_url,
                'raw': raw_text[:100]
            }

            if not pending_orders[found_zone]:
                pending_orders[found_zone].append(new_order)
                asyncio.create_task(process_and_send_batch(found_zone))
            else:
                pending_orders[found_zone].append(new_order)
                
        except Exception as e:
            print(f"âŒ Error: {e}")

async def process_and_send_batch(zone):
    await asyncio.sleep(3000)  # Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙˆÙ‚Øª Ù„Ù€ 10 Ø¯Ù‚Ø§Ø¦Ù‚ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙˆØ§ÙÙ‚
    
    orders = pending_orders[zone]
    if not orders: return
    pending_orders[zone] = []

    batch_msg = f"ğŸšš **Ø­Ø²Ù…Ø© Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ© | {zone}**\n"
    batch_msg += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"

    # ØªØµÙ†ÙŠÙ Ø°ÙƒÙŠ: ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§ÙˆÙŠØ± Ø§Ù„ØªÙŠ Ù„Ù‡Ø§ Ù†ÙØ³ Ø§Ù„ÙˆØ¬Ù‡Ø© Ø£Ùˆ ÙˆØ¬Ù‡Ø§Øª Ù‚Ø±ÙŠØ¨Ø©
    clusters = {}
    for o in orders:
        clusters.setdefault(o['dest'], []).append(o)

    for d_name, group in clusters.items():
        batch_msg += f"ğŸ“ **Ø§Ù„ÙˆØ¬Ù‡Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: {d_name}**\n"
        
        # Ø¥Ø°Ø§ ÙˆØ¬Ø¯Ù†Ø§ Ø£ÙƒØ«Ø± Ù…Ù† Ø·Ù„Ø¨ Ù„Ù†ÙØ³ Ø§Ù„ÙˆØ¬Ù‡Ø© Ù†Ø¶Ø¹ Ø¹Ù„Ø§Ù…Ø© "ØªÙˆØ§ÙÙ‚"
        if len(group) > 1:
            batch_msg += "âœ¨ *ÙŠÙˆØ¬Ø¯ ØªÙˆØ§ÙÙ‚ Ø¹Ø§Ù„ÙŠ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†*\n"
            
        for o in group:
            batch_msg += (
                f"ğŸ”¸ Ù…Ù†: `{o['origin']}`\n"
                f"ğŸ’° Ø§Ù„Ø³Ø¹Ø±: `{o['price']}` | ğŸ‘¥ Ø±ÙƒØ§Ø¨: `{o['passengers']}`\n"
                f"ğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„: [{o['name']}]({o['link']})\n"
                f"ğŸ“ Ø§Ù„Ù…Ø³Ø§ÙØ©: `~{o['dist']} ÙƒÙ…` | [Ø§Ù„Ù…ØµØ¯Ø±]({o['msg_url']})\n"
                f"â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯\n"
            )
    
    batch_msg += f"\nâœ… ØªÙ… ØªØ¬Ù…ÙŠØ¹ {len(orders)} Ø·Ù„Ø¨Ø§Øª Ù…ØªÙˆØ§ÙÙ‚Ø©."
    
    target = ZONE_GROUPS.get(zone)
    if target:
        await client.send_message(target, batch_msg, link_preview=False)

# ... [Flask Ùˆ Thread ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ± ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ] ...
# ==========================================
# ğŸŒ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±
# ==========================================
app = Flask('')
@app.route('/')
def home(): return "Smart Logistics Active ğŸš€"

def run_web():
    app.run(host='0.0.0.0', port=int(os.environ.get("PORT", 8080)))

if __name__ == '__main__':
    Thread(target=run_web).start()
    client.start()
    client.run_until_disconnected()