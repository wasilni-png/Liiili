import re
import os
import asyncio
import math
from threading import Thread
from flask import Flask
from telethon import TelegramClient, events
from telethon.sessions import StringSession

# ==========================================
# โ๏ธ ุงูุฅุนุฏุงุฏุงุช ูุงููุชุบูุฑุงุช (Config)
# ==========================================

API_ID = os.environ.get("API_ID", 33888256)
API_HASH = os.environ.get("API_HASH", 'bb1902689a7e203a7aedadb806c08854')
SESSION_STRING = os.environ.get("SESSION_STRING", "1BJWap1sBu40j3ZH7Al9W21d4ghtN5RRH8mHEvqNj2MnWyhv1DVOLP86bxbf4BGk3bnuFeLCQVPKBvO2TRT8f5DWsTq-Qo8guDA0n2F6Zsb-dod4hEm3AeszVGzQp3JQmyk3HgmT2YB7hlMuA2ebcYO1jo_nRWu8Ib7ENq8XpjaTYtcrRhUfDgMBGg6ySQjhZWs4ICnAk79o3T9ICewTxZg6O2BlJMpP6kQThQRyWHGaytoadkvoL5tJcnrivDgsUSfY5r4IzrTE00RH9F7dTbuu9jeLqb2WKDZXcCM88_8gQGrB0etCtFZD7UnHydyQagi3i7pZZimgHOb_s8Xd7xPFjaP8Vuf4=")

# ุชู ุฅุฒุงูุฉ PUBLIC_GROUP_ID ูู ููุง

ZONE_GROUPS = {
    'ุดูุงู ุฌุฏุฉ': -1003760776543, 
    'ูุณุท ุฌุฏุฉ': -1003596443115,
    'ุฌููุจ ุฌุฏุฉ': -1003817286093,
    'ุดุฑู ุฌุฏุฉ': -1003771356422
}

KEYWORDS = ['ุดูุฑู', 'ุจุงูุดูุฑ', 'ุดูุฑูุง', 'ุนูุฏ', 'ุฏูุงู', 'ูุดูุงุฑ ุซุจุงุช']

# ==========================================
# ๐ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุฌุบุฑุงููุฉ
# ==========================================

JEDDAH_ZONES = {
    'ุดูุงู ุฌุฏุฉ': [
        'ุฃุจุญุฑ ุงูุดูุงููุฉ', 'ุฃุจุญุฑ ุงูุฌููุจูุฉ', 'ุงูุญูุฏุงููุฉ', 'ุงููุฑุฌุงู', 'ุงูุจุณุงุชูู', 'ุงููุนูู', 
        'ุงููุญูุฏูุฉ', 'ุงูุดุงุทุฆ', 'ุงูุฑุญููู', 'ุฐูุจุงู', 'ุทูุจุฉ', 'ุงูุตุงูุฉ ุงูุดูุงููุฉ', 'ุงููุฑูุณูุฉ',
        'ุงูููุงุญ', 'ุงูุฑูุงุถ', 'ุงูุฒูุฑุฏ', 'ุงููุงููุช', 'ุงููุคูุค', 'ุงูููุงุฑ', 'ุงูุตูุงุฑู', 
        'ุฎุงูุฏ ุงููููุฐุฌูุฉ', 'ูุทุงุฑ ุงูููู ุนุจุฏุงูุนุฒูุฒ', 'ุงูุฃููุงุฌ', 'ุงููุฑุฏูุณ', 'ุงูุดุฑุงุน', 
        'ุงูููุงุฑุงุช', 'ุงูุตุงูุญูุฉ', 'ุงููุงุฌุฏ', 'ุงูุณูุทุงู', 'ุงููุฒูุฉ'
    ],
    'ูุณุท ุฌุฏุฉ': [
        'ุงูุฑูุถุฉ', 'ุงูุณูุงูุฉ', 'ุงูุชุญููุฉ', 'ุงูุนุฒูุฒูุฉ', 'ูุดุฑูุฉ', 'ุงููุณูู', 'ุงูููุญุงุก',
        'ุจูู ูุงูู', 'ุงูุญูุฑุงุก', 'ุงูููุตููุฉ', 'ุงูุฑุจูุฉ', 'ุงูุตูุง', 'ุงููุฑูุฉ', 'ุงูุจูุงุฏู',
        'ุงูุงูุฏูุณ', 'ุงููุณุงุนุฏูุฉ', 'ุงููุฑูุฏ', 'ุงูุฑุญุงุจ', 'ููุฏุฑุฉ', 'ุงูุนูุงุฑูุฉ', 'ุงูุตุญููุฉ', 
        'ุงูุจุบุฏุงุฏูุฉ', 'ุญู ุงูุจูุฏ', 'ุงูุฑููุณ', 'ุงูููุฏุงููุฉ', 'ุงูุซุนุงูุจุฉ', 'ุงููุฑูุงุช', 'ุงูุณุจูู'
    ],
    'ุฌููุจ ุฌุฏุฉ': [
        'ุงููุฒูุฑูุฉ', 'ุงูุฃููุฑ ููุงุฒ', 'ุงูุฃููุฑ ุนุจุฏุงููุฌูุฏ', 'ุงูุนุฏู', 'ุงูุณูุงุจู', 'ุงูุฑูุงุจู', 
        'ุงูุฎูุฑุฉ', 'ุบููู', 'ุงููุญุฌุฑ', 'ุงููุฑูููุฉ', 'ุงูุฃุฌุงููุฏ', 'ุญู ุงููุฏู', 'ุงููุฏุงุฆู', 
        'ุงููุถููุฉ', 'ูุณุชูุฏุนุงุช ุงูุฅุณูุงู', 'ุญู ุจุชุฑูููู', 'ุงูููุฒูู', 'ุงูุณุฑูุฑูุฉ', 'ุงููุฑุณูุงุช',
        'ุงูุฃุฌูุงุฏ ุงูุฌููุจู', 'ุถุงุญูุฉ ุงูุญุฑุฒุงุช', 'ุงููุฏู 2'
    ],
    'ุดุฑู ุฌุฏุฉ': [
        'ุงูุณุงูุฑ', 'ุงูููุงุฑ', 'ุงูุฃุฌูุงุฏ', 'ูุฎุทุท ุงูููุฏ', 'ุงูุญุฑุงุฒุงุช', 'ุงูุณูููุงููุฉ', 
        'ุงููุงุญุฉ', 'ุจุฑููุงู', 'ุงูุชูุณูุฑ', 'ุงูุฑุงูุฉ', 'ุงููุฎูู', 'ูุฎุทุท ุงูุฑูุงุถ', 
        'ุญู ุงูุณูููุฉ', 'ุงููุฑูุฉ ุงูุดุฑููุฉ', 'ุฃู ุงูุญุจููู', 'ูุงุฏู ูุฑูุฎ', 'ูุฎุทุท ูุฑูุฎ',
        'ุงููุฒูุฉ ุงูุดุฑููุฉ', 'ุจูู ูุงูู ุงูุดุฑููุฉ', 'ูุฎุทุท ุงููุตุจุงุญ'
    ]
}

DISTRICT_COORDS = {
    'ุฃุจุญุฑ ุงูุดูุงููุฉ': (21.7511, 39.1235), 'ุฃุจุญุฑ ุงูุฌููุจูุฉ': (21.7144, 39.1256),
    'ุงูุญูุฏุงููุฉ': (21.7831, 39.2161), 'ุงููุฑุฌุงู': (21.7011, 39.1022),
    'ุงูุจุณุงุชูู': (21.6885, 39.1255), 'ุงููุนูู': (21.6255, 39.1550),
    'ุงููุญูุฏูุฉ': (21.6500, 39.1350), 'ุงูุดุงุทุฆ': (21.6100, 39.1150),
    'ุงูุฑุญููู': (21.8200, 39.1500), 'ุฐูุจุงู': (21.9333, 39.1167),
    'ุทูุจุฉ': (21.8000, 39.1800), 'ุงูุตุงูุฉ ุงูุดูุงููุฉ': (21.6950, 39.1620),
    'ุงููุฑูุณูุฉ': (21.8150, 39.2250), 'ุงูููุงุญ': (21.7900, 39.2300),
    'ุงูุฑูุงุถ': (21.8450, 39.2350), 'ุงูุฒูุฑุฏ': (21.7750, 39.1100),
    'ุงููุงููุช': (21.7650, 39.1150), 'ุงููุคูุค': (21.7450, 39.1050),
    'ุงูุตูุงุฑู': (21.7850, 39.1250), 'ุฎุงูุฏ ุงููููุฐุฌูุฉ': (21.7200, 39.1850),
    'ูุทุงุฑ ุงูููู ุนุจุฏุงูุนุฒูุฒ': (21.6833, 39.1500), 'ุงูุฃููุงุฌ': (21.7300, 39.1100),
    'ุงููุฑุฏูุณ': (21.7400, 39.1200), 'ุงูุดุฑุงุน': (21.7250, 39.1150),
    'ุงูููุงุฑุงุช': (21.7100, 39.1300), 'ุงูุตุงูุญูุฉ': (21.7950, 39.2100),
    'ุงููุงุฌุฏ': (21.8050, 39.2200), 'ุงูุณูุทุงู': (21.8100, 39.2150),
    'ุงููุฒูุฉ': (21.6400, 39.1700),
    'ุงูุฑูุถุฉ': (21.5667, 39.1500), 'ุงูุณูุงูุฉ': (21.5833, 39.1500),
    'ุงูุชุญููุฉ': (21.5510, 39.1650), 'ุงูุนุฒูุฒูุฉ': (21.5450, 39.1850),
    'ูุดุฑูุฉ': (21.5350, 39.1950), 'ุงููุณูู': (21.5050, 39.2250),
    'ุงูููุญุงุก': (21.4950, 39.2350), 'ุจูู ูุงูู': (21.5150, 39.2150),
    'ุงูุญูุฑุงุก': (21.5200, 39.1550), 'ุงูููุตููุฉ': (21.5750, 39.1750),
    'ุงูุฑุจูุฉ': (21.5950, 39.1850), 'ุงูุตูุง': (21.5850, 39.2050),
    'ุงููุฑูุฉ': (21.6150, 39.2050), 'ุงูุจูุงุฏู': (21.5950, 39.1650),
    'ุงูุงูุฏูุณ': (21.5400, 39.1450), 'ุงููุณุงุนุฏูุฉ': (21.5300, 39.1700),
    'ุงููุฑูุฏ': (21.5250, 39.2150), 'ุงูุฑุญุงุจ': (21.5550, 39.2150),
    'ููุฏุฑุฉ': (21.4950, 39.2050), 'ุงูุนูุงุฑูุฉ': (21.4880, 39.1950),
    'ุงูุตุญููุฉ': (21.4850, 39.1900), 'ุงูุจุบุฏุงุฏูุฉ': (21.4950, 39.1850),
    'ุญู ุงูุจูุฏ': (21.4833, 39.1833), 'ุงูุฑููุณ': (21.5100, 39.1650),
    'ุงูููุฏุงููุฉ': (21.4750, 39.1800), 'ุงูุซุนุงูุจุฉ': (21.4650, 39.1850),
    'ุงููุฑูุงุช': (21.4600, 39.1900), 'ุงูุณุจูู': (21.4700, 39.1900),
    'ุงููุฒูุฑูุฉ': (21.4600, 39.2350), 'ุงูุฃููุฑ ููุงุฒ': (21.4250, 39.2650),
    'ุงูุฃููุฑ ุนุจุฏุงููุฌูุฏ': (21.4050, 39.2750), 'ุงูุนุฏู': (21.4550, 39.2550),
    'ุงูุณูุงุจู': (21.3650, 39.2850), 'ุงูุฑูุงุจู': (21.4750, 39.2550),
    'ุงูุฎูุฑุฉ': (21.3000, 39.2200), 'ุบููู': (21.4450, 39.2050),
    'ุงููุญุฌุฑ': (21.4400, 39.1950), 'ุงููุฑูููุฉ': (21.3250, 39.2350),
    'ุงูุฃุฌุงููุฏ': (21.3850, 39.2850), 'ุญู ุงููุฏู': (21.3950, 39.2550),
    'ุงููุฏุงุฆู': (21.3500, 39.2450), 'ุงููุถููุฉ': (21.3150, 39.2550),
    'ูุณุชูุฏุนุงุช ุงูุฅุณูุงู': (21.4150, 39.2250), 'ุญู ุจุชุฑูููู': (21.4350, 39.1850),
    'ุงูููุฒูู': (21.2850, 39.2050), 'ุงูุณุฑูุฑูุฉ': (21.3350, 39.1950),
    'ุงููุฑุณูุงุช': (21.4000, 39.2400), 'ุงููุฏู 2': (21.3800, 39.2600),
    'ุงูุณุงูุฑ': (21.6050, 39.2450), 'ุงูููุงุฑ': (21.6050, 39.2300),
    'ุงูุฃุฌูุงุฏ': (21.6150, 39.2550), 'ูุฎุทุท ุงูููุฏ': (21.6250, 39.2650),
    'ุงูุญุฑุงุฒุงุช': (21.4550, 39.3650), 'ุงูุณูููุงููุฉ': (21.4950, 39.2450),
    'ุงููุงุญุฉ': (21.5650, 39.2450), 'ุจุฑููุงู': (21.6550, 39.2550),
    'ุงูุชูุณูุฑ': (21.5750, 39.2750), 'ุงูุฑุงูุฉ': (21.6250, 39.2750),
    'ุงููุฎูู': (21.5250, 39.2650), 'ูุฎุทุท ุงูุฑูุงุถ': (21.8450, 39.2350),
    'ุญู ุงูุณูููุฉ': (21.4450, 39.2850), 'ุงููุฑูุฉ ุงูุดุฑููุฉ': (21.6250, 39.2150),
    'ุฃู ุงูุญุจููู': (21.5850, 39.2950), 'ูุงุฏู ูุฑูุฎ': (21.5450, 39.3050),
    'ูุฎุทุท ูุฑูุฎ': (21.5500, 39.3100), 'ูุฎุทุท ุงููุตุจุงุญ': (21.5900, 39.2600)
}


# ==========================================
# ๐๏ธ ุงูุฏูุงู ุงููุณุงุนุฏุฉ
# ==========================================

def normalize_arabic_text(text):
    if not text: return ""
    text = text.strip()
    text = re.sub(r'[ุฃุฅุข]', 'ุง', text)
    text = re.sub(r'ุฉ', 'ู', text)
    tashkeel = re.compile(r'[\u064B-\u0652]')
    text = re.sub(tashkeel, '', text)
    text = re.sub(r'http\S+|www\S+|@\S+', '', text)
    return text

def calculate_distance(origin_name, dest_name):
    coords1 = DISTRICT_COORDS.get(origin_name)
    coords2 = DISTRICT_COORDS.get(dest_name)
    if not coords1 or not coords2: return None, None
    
    lat1, lon1 = coords1
    lat2, lon2 = coords2
    R = 6371
    dlat = math.radians(lat2 - lat1)
    dlon = math.radians(lon2 - lon1)
    a = (math.sin(dlat / 2) ** 2 + math.cos(math.radians(lat1)) * math.cos(math.radians(lat2)) * math.sin(dlon / 2) ** 2)
    c = 2 * math.atan2(math.sqrt(a), math.sqrt(1 - a))
    
    actual_dist = round(R * c * 1.3, 1)
    est_time = round((actual_dist / 40) * 60) + 10
    return actual_dist, est_time

# ==========================================
# ๐ง ููุทู ุงููุนุงูุฌุฉ ุงูุฃุณุงุณู
# ==========================================

client = TelegramClient(StringSession(SESSION_STRING), API_ID, API_HASH)
pending_orders = {zone: [] for zone in JEDDAH_ZONES.keys()}

@client.on(events.NewMessage)
async def main_handler(event):
    if not event.is_group: return
    raw_text = event.raw_text
    if not raw_text: return

    processed_text = normalize_arabic_text(raw_text)
    has_keyword = any(normalize_arabic_text(k) in processed_text for k in KEYWORDS)
    if not has_keyword: return

    origin, dest, found_zone = "ุบูุฑ ูุญุฏุฏ", "ุบูุฑ ูุญุฏุฏ", None

    for zone, districts in JEDDAH_ZONES.items():
        for d in districts:
            norm_d = normalize_arabic_text(d)
            if norm_d in processed_text:
                if ' ูู ' + norm_d in processed_text:
                    origin, found_zone = d, zone
                elif ' ุงูู ' + norm_d in processed_text or ' ูุญู ' + norm_d in processed_text:
                    dest = d
                else:
                    if origin == "ุบูุฑ ูุญุฏุฏ": origin, found_zone = d, zone

    if found_zone:
        try:
            dist, time = calculate_distance(origin, dest)
            sender = await event.get_sender()
            sender_name = sender.first_name if sender else "ุนููู"
            
            # ุฑูุงุจุท ุงูุชูุงุตู ูุงููุตุฏุฑ
            user_link = f"tg://user?id={sender.id}" if sender else "#"
            chat = await event.get_chat()
            chat_id = str(chat.id).replace("-100", "")
            msg_url = f"https://t.me/c/{chat_id}/{event.message.id}"

            time_m = re.search(r'ุงูุณุงุนู\s?(\d+)', raw_text)
            req_time = time_m.group(0) if time_m else "ุบูุฑ ูุญุฏุฏ"

            new_order = {
                'origin': origin, 'dest': dest, 'dist': dist, 'time': time,
                'req_time': req_time, 'name': sender_name, 'text': raw_text[:120],
                'link': user_link, 'msg_url': msg_url
            }

            # ุชู ุญุฐู ุฌุฒุก ุงูุฅุฑุณุงู ุงูููุฑู ูููุฑูุจ ุงูุนุงู ูู ููุง โ

            if not pending_orders[found_zone]:
                pending_orders[found_zone].append(new_order)
                asyncio.create_task(process_and_send_batch(found_zone))
            else:
                pending_orders[found_zone].append(new_order)
                
            print(f"๐ฅ ุงูุชูุงุท ุทูุจ ูู {origin} (ูุทุงู {found_zone})")
        except Exception as e:
            print(f"โ ุฎุทุฃ ูุนุงูุฌุฉ: {e}")

async def process_and_send_batch(zone):
    await asyncio.sleep(300) # ุชุฌููุน ููุฏุฉ 5 ุฏูุงุฆู
    if not pending_orders[zone]: return

    batch_msg = f"๐ **ุญุฒูุฉ ุงููุณุงุฑุงุช ุงูุฐููุฉ | {zone}**\n"
    batch_msg += "โโโโโโโโโโโโโโโโโโ\n\n"

    clusters = {}
    for o in pending_orders[zone]:
        clusters.setdefault(o['dest'], []).append(o)

    for d_name, orders in clusters.items():
        batch_msg += f"๐ฉ **ุงููุฌูุฉ: {d_name}**\n"
        for o in orders:
            batch_msg += (
                f"๐น ูู: `{o['origin']}` | ๐ `{o['req_time']}`\n"
                f"๐ค **ุงูุนููู:** [{o['name']}]({o['link']})\n"
                f"๐ `~{o['dist']} ูู` | โณ `~{o['time']} ุฏ`\n"
                f"๐ [ุฑุงุจุท ุงููุตุฏุฑ (ุงูุฑุณุงูุฉ ุงูุฃุตููุฉ)]({o['msg_url']})\n"
                f"โฏโฏโฏโฏโฏโฏโฏโฏโฏโฏ\n"
            )
    
    batch_msg += f"\nโ๏ธ ุงูุชูุณูู ุงูุณุฑูุน ูุฎุฏู ุงูุฌููุน."
    
    target_group_id = ZONE_GROUPS.get(zone)
    if target_group_id:
        await client.send_message(target_group_id, batch_msg, link_preview=False)
    
    pending_orders[zone] = []

# ==========================================
# ๐ ุชุดุบูู ุงูุณูุฑูุฑ
# ==========================================
app = Flask('')
@app.route('/')
def home(): return "Smart Logistics Active ๐"

def run_web():
    app.run(host='0.0.0.0', port=int(os.environ.get("PORT", 8080)))

if __name__ == '__main__':
    Thread(target=run_web).start()
    client.start()
    client.run_until_disconnected()